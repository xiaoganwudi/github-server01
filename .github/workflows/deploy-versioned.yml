name: Deploy VitePress (versioned)  # 工作流名称

on:
  push:
    branches: [ main ]               # main 分支推送部署到 latest
    tags: 
      - "v*.*.*"                     # tag 推送（vX.Y.Z）部署到对应目录
  workflow_dispatch: {}              # 允许手动触发

# 必要权限：确保 GITHUB_TOKEN 有写入内容与 Pages 的权限
permissions:
  contents: write
  pages: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. checkout 源码（fetch-depth:0 能拿到 tags）
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. 设置 Node
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # 3. 安装依赖
      - name: Install dependencies
        run: npm ci

      # 4. 确定要部署的版本（环境变量：DOCS_VERSION）
      - name: Determine version
        id: vars
        run: |
          echo "GITHUB_REF=${GITHUB_REF}"
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
            echo "Detected tag: ${TAG_NAME}"
            echo "DOCS_VERSION=${TAG_NAME}" >> $GITHUB_ENV
          elif [[ "${GITHUB_REF}" == refs/heads/main ]]; then
            echo "Detected branch: main"
            echo "DOCS_VERSION=latest" >> $GITHUB_ENV
          else
            echo "Not a deployable ref: ${GITHUB_REF}"
            echo "DOCS_VERSION=skip" >> $GITHUB_ENV
          fi

      # 5. 构建 VitePress（使用你 package.json 的脚本）
      - name: Build VitePress site
        if: env.DOCS_VERSION != 'skip'
        env:
          DOCS_VERSION: ${{ env.DOCS_VERSION }}
        run: |
          echo "Building docs for $DOCS_VERSION"
          # 把版本注入到构建环境（你的 config.js 已读取 process.env.DOCS_VERSION）
          export DOCS_VERSION=$DOCS_VERSION
          npm run docs:build
          echo "Build output list:"
          ls -la .vitepress/dist || true

      # 6. clone gh-pages 并把构建结果复制到对应子目录，提交并 push
      - name: Publish to gh-pages (manual git)
        if: env.DOCS_VERSION != 'skip'
        env:
          DOCS_VERSION: ${{ env.DOCS_VERSION }}
          REPO: ${{ github.repository }}
          # 使用内置 token 通过 HTTPS 推送
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          # 注意：若仓库是 GitHub Enterprise 或非 github.com，下面 clone URL 需调整
          REPO_URL="https://x-access-token:${GITHUB_TOKEN}@github.com/${REPO}.git"

          # 如果 gh-pages 分支不存在，git clone 会失败 — 用 clone 后创建分支逻辑处理
          TMP=gh-pages-tmp
          rm -rf $TMP
          git clone --single-branch --branch gh-pages "$REPO_URL" $TMP 2>/dev/null || (
            echo "gh-pages branch not found — creating new gh-pages branch"
            mkdir -p $TMP
            cd $TMP
            git init
            git checkout --orphan gh-pages
            git -c user.name="github-actions[bot]" -c user.email="github-actions[bot]@users.noreply.github.com" commit --allow-empty -m "Initialize gh-pages"
            git push "$REPO_URL" HEAD:gh-pages
            cd ..
            git clone --single-branch --branch gh-pages "$REPO_URL" $TMP
          )

          # 进入 gh-pages 工作区
          cd $TMP

          # 确保 git 用户配置（用于 commit）
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 删除目标目录并复制新构建文件（保持其他版本目录不变）
          echo "Deploying to directory: ${DOCS_VERSION}"
          rm -rf "${DOCS_VERSION}"
          mkdir -p "${DOCS_VERSION}"
          # 复制构建产物（根据你的构建输出修改路径）
          cp -r ../.vitepress/dist/* "${DOCS_VERSION}/"

          # 列出变更，便于调试
          git status --porcelain
          git add -A
          # 如果没有变更，git commit 会返回非零；使用 || true 来避免失败
          if git diff --cached --quiet; then
            echo "No changes to commit for ${DOCS_VERSION}"
          else
            git commit -m "chore(docs): deploy ${DOCS_VERSION} from ${GITHUB_SHA}"
            git push origin gh-pages
          fi

          echo "Publish finished."
