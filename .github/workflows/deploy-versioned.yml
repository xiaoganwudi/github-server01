name: ğŸš€ Deploy Versioned Docs

# è§¦å‘æ¡ä»¶ï¼š
# - æ‰‹åŠ¨æ‰§è¡Œï¼ˆworkflow_dispatchï¼‰
# - æ¨é€åˆ° main åˆ†æ”¯
# - æ¨é€ tagï¼ˆä¾‹å¦‚ v1.0.1ï¼‰
on:
  workflow_dispatch:
  push:
    branches:
      - main
    tags:
      - "v*.*.*"

# é¿å…å¤šä¸ªéƒ¨ç½²ä»»åŠ¡åŒæ—¶æ‰§è¡Œ
concurrency:
  group: deploy-docs
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ æ‹‰å–ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²ï¼ˆè¯»å– tag ç”¨ï¼‰

      # 2ï¸âƒ£ è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3ï¸âƒ£ å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: npm ci

      # 4ï¸âƒ£ åˆ¤æ–­å½“å‰éƒ¨ç½²ç‰ˆæœ¬
      # å¦‚æœæ˜¯ tagï¼ˆå¦‚ v1.0.1ï¼‰ï¼ŒDOCS_VERSION=v1.0.1
      # å¦åˆ™ï¼ˆmain åˆ†æ”¯ï¼‰DOCS_VERSION=latest
      - name: Determine version
        id: vars
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            echo "DOCS_VERSION=${GITHUB_REF_NAME}" >> $GITHUB_ENV
          else
            echo "DOCS_VERSION=latest" >> $GITHUB_ENV
          fi

          # è§£ææ‰€æœ‰ tag ç‰ˆæœ¬åˆ—è¡¨ï¼Œç”¨äºç”Ÿæˆ version åˆ—è¡¨
          ALL_VERSIONS=$(git tag --list "v*" | jq -R -s -c 'split("\n")[:-1]')
          echo "ALL_VERSIONS=$ALL_VERSIONS" >> $GITHUB_ENV

      # 5ï¸âƒ£ æ„å»º VitePress é™æ€æ–‡ä»¶
      - name: Build VitePress site
        run: |
          echo "Building docs for version: $DOCS_VERSION"
          export DOCS_VERSION=$DOCS_VERSION
          export ALL_VERSIONS=$ALL_VERSIONS
          npm run docs:build

      # 6ï¸âƒ£ éƒ¨ç½²åˆ° gh-pages åˆ†æ”¯
      # æ³¨æ„ï¼šæ¯ä¸ªç‰ˆæœ¬éƒ¨ç½²åœ¨ä¸åŒç›®å½•ä¸­ï¼ˆä¾‹å¦‚ /latest/, /v1.0.1/ï¼‰
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .vitepress/dist
          # å°†æ„å»ºç»“æœæ”¾å…¥ gh-pages åˆ†æ”¯å¯¹åº”ç›®å½•
          destination_dir: ${{ env.DOCS_VERSION }}
          keep_files: true  # ä¿ç•™å…¶ä»–ç‰ˆæœ¬ç›®å½•ï¼Œé˜²æ­¢è¦†ç›–
          commit_message: "chore: deploy docs for ${{ env.DOCS_VERSION }}"
